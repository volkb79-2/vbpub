services:
  {{ pwmcp_server.name }}:
    image: {{ pwmcp_server.image.registry }}/{{ pwmcp_server.image.namespace }}/{{ pwmcp_server.image.name }}:{{ pwmcp_server.image.tag }}
    container_name: {{ deploy.project_name }}-{{ deploy.environment_tag }}-{{ pwmcp_server.name }}
    user: "{{ pwmcp_server.runtime.container_uid }}:{{ pwmcp_server.runtime.container_gid }}"
    environment:
      - WS_PORT={{ pwmcp_server.ports.ws_internal }}
      - WS_HOST=0.0.0.0
      - WS_AUTH_TOKEN={{ pwmcp_server.runtime.ws_auth_token }}
      - WS_MAX_SESSIONS={{ pwmcp_server.runtime.ws_max_sessions }}
      - WS_SESSION_TIMEOUT={{ pwmcp_server.runtime.ws_session_timeout }}
      - WS_EVENT_STREAM_ENABLED={{ pwmcp_server.runtime.ws_event_stream_enabled }}
      - WS_CONSOLE_STREAM_ENABLED={{ pwmcp_server.runtime.ws_console_stream_enabled }}
      - WS_ARTIFACT_ROOT={{ pwmcp_server.runtime.ws_artifact_root }}
      - WS_WORKSPACE_ROOT={{ pwmcp_server.runtime.ws_workspace_root }}
      - WS_ARTIFACT_MAX_BYTES={{ pwmcp_server.runtime.ws_artifact_max_bytes }}
      - ARTIFACT_HTTP_ENABLED={{ pwmcp_server.runtime.artifact_http_enabled }}
      - ARTIFACT_HTTP_HOST={{ pwmcp_server.runtime.artifact_http_host }}
      - ARTIFACT_HTTP_PORT={{ pwmcp_server.ports.artifact_http_internal }}
      - ARTIFACT_HTTP_AUTH_REQUIRED={{ pwmcp_server.runtime.artifact_http_auth_required }}
      - WS_HAR_ENABLED={{ pwmcp_server.runtime.ws_har_enabled }}
      - WS_HAR_CONTENT={{ pwmcp_server.runtime.ws_har_content }}
      - BROWSER_POOL_ENABLED={{ pwmcp_server.runtime.browser_pool_enabled }}
      - BROWSER_POOL_SIZE={{ pwmcp_server.runtime.browser_pool_size }}

      - MCP_ENABLED={{ pwmcp_server.runtime.mcp_enabled }}
      - MCP_PORT={{ pwmcp_server.ports.mcp_internal }}
      - MCP_SERVER_NAME={{ pwmcp_server.runtime.mcp_server_name }}
      - MCP_AUTH_TOKEN={{ pwmcp_server.runtime.mcp_auth_token }}
      - MCP_ALLOWED_HOSTS={{ pwmcp_server.runtime.mcp_allowed_hosts }}
      - MCP_ALLOWED_ORIGINS={{ pwmcp_server.runtime.mcp_allowed_origins }}

      - ACCESS_TOKEN={{ pwmcp_server.runtime.access_token }}
      - AUTH_REQUIRED={{ pwmcp_server.runtime.auth_required }}

      - PLAYWRIGHT_HEADLESS={{ pwmcp_server.runtime.playwright_headless }}
      - PLAYWRIGHT_BROWSER={{ pwmcp_server.runtime.playwright_browser }}

      - SSL_ENABLED=false
      - SSL_CERT_PATH=/certs/server.crt
      - SSL_KEY_PATH=/certs/server.key

      - HEALTH_ENABLED={{ pwmcp_server.health.enabled }}
      - HEALTH_PORT={{ pwmcp_server.ports.health_internal }}
      - HEALTH_SOCKET_TIMEOUT={{ pwmcp_server.health.socket_timeout }}
      - SELFTEST_URL={{ pwmcp_server.health.selftest_url }}
      - SELFTEST_TIMEOUT={{ pwmcp_server.health.selftest_timeout }}

    {% if pwmcp_server.ports.expose_ws or pwmcp_server.ports.expose_mcp or pwmcp_server.ports.expose_health or pwmcp_server.ports.expose_artifact_http %}
    ports:
      {% if pwmcp_server.ports.expose_ws %}
      - "{{ pwmcp_server.ports.ws_external }}:{{ pwmcp_server.ports.ws_internal }}"
      {% endif %}
      {% if pwmcp_server.ports.expose_mcp %}
      - "{{ pwmcp_server.ports.mcp_external }}:{{ pwmcp_server.ports.mcp_internal }}"
      {% endif %}
      {% if pwmcp_server.ports.expose_health %}
      - "{{ pwmcp_server.ports.health_external }}:{{ pwmcp_server.ports.health_internal }}"
      {% endif %}
      {% if pwmcp_server.ports.expose_artifact_http %}
      - "{{ pwmcp_server.ports.artifact_http_external }}:{{ pwmcp_server.ports.artifact_http_internal }}"
      {% endif %}
    {% endif %}

    volumes:
      - {{ pwmcp_server.volumes.workspaces_dir }}:/workspaces:rw
      - {{ pwmcp_server.volumes.certs_dir }}:/certs:ro

    shm_size: "2gb"
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost', int('{{ pwmcp_server.ports.ws_internal }}'))); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  {% if reverse_proxy.enabled %}
  reverse-proxy:
    image: nginx:alpine
    container_name: {{ deploy.project_name }}-{{ deploy.environment_tag }}-proxy
    environment:
      PUBLIC_FQDN: {{ reverse_proxy.public_fqdn }}
      REVERSE_PROXY_HTTPS_PORT: {{ reverse_proxy.https_port }}
      REVERSE_PROXY_HTTP_PORT: {{ reverse_proxy.http_port }}
    command:
      - /bin/sh
      - -c
      - |
        envsubst '${PUBLIC_FQDN}' < /etc/nginx/templates/nginx.conf.template > /etc/nginx/conf.d/default.conf
        exec nginx -g 'daemon off;'
    volumes:
      - {{ reverse_proxy.letsencrypt_dir }}:/etc/letsencrypt:ro
      - ./reverse-proxy/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
    ports:
      - "{{ reverse_proxy.https_port }}:443"
      {% if reverse_proxy.http_enabled %}
      - "{{ reverse_proxy.http_port }}:80"
      {% endif %}
    depends_on:
      - {{ pwmcp_server.name }}
    restart: unless-stopped
  {% endif %}

networks:
  default:
    name: {{ deploy.network_name }}
